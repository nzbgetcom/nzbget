name: windows build 

on:
  workflow_call:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022

    steps:
    
    - name: Checkout
      uses: actions/checkout@v4

    - name: Prepare build environment
      run: |
        $ProgressPreference = "SilentlyContinue"
        Invoke-WebRequest https://github.com/nzbgetcom/build-files/releases/download/v1.0/vcpkg-full.zip -OutFile "${{ github.workspace }}\vcpkg.zip"
        Rename-Item -path "C:\vcpkg" -NewName "C:\vcpkg.old"
        Expand-Archive -Path "${{ github.workspace }}\vcpkg.zip" -DestinationPath C:\
        Invoke-WebRequest https://github.com/nzbgetcom/build-files/releases/download/v1.0/nzbget-windows-tools.zip -OutFile "${{ github.workspace }}\tools.zip"
        Expand-Archive -Path "${{ github.workspace }}\tools.zip" -DestinationPath C:\

    - name: Build
      run: |
        $BuildParams="-BuildRelease -Build32 -Build64 -BuildSetup"
        If (-not ($env:GITHUB_REF_NAME -eq "main")) {
          $BuildParams="$BuildParams -BuildTesting"
        }
        If (($env:GITHUB_REF_NAME -eq "main") -or ($env:GITHUB_REF_NAME -eq "develop")) {
          $BuildParams="$BuildParams -BuildDebug"
        }
        Invoke-Expression "windows\build-nzbget.ps1 $BuildParams"

    - name: Rename build artifacts
      if: github.ref_name != 'main' && github.ref_name != 'develop'
      run: |
        $Output="build"
        $Suffix = $env:GITHUB_REF_NAME.Replace("/","-")
        ForEach ($File In Get-ChildItem -Path $Output -Filter "*.exe") {
          Rename-Item -Path "$Output\$($File.Name)" -NewName $File.Name.Replace("-bin-windows-setup.exe", "-$Suffix-bin-windows-setup.exe")
        }

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nzbget-windows-installers
        path: build\*.exe
        retention-days: 5
